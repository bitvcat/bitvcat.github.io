<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="990px" preserveAspectRatio="none" style="width:614px;height:990px;" version="1.1" viewBox="0 0 614 990" width="614px" zoomAndPan="magnify"><defs><filter height="300%" id="fixyfwc30owyw" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFBBBB" filter="url(#fixyfwc30owyw)" height="67.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="60.5" y="122.5625"/><rect fill="#E9967A" filter="url(#fixyfwc30owyw)" height="575.6016" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="410.5" y="346.8984"/><rect fill="#87CEEB" filter="url(#fixyfwc30owyw)" height="506.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415.5" y="389.0313"/><rect fill="#FFB6C1" filter="url(#fixyfwc30owyw)" height="467.4688" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="10" y="409.0313"/><rect fill="#FFFFE0" filter="url(#fixyfwc30owyw)" height="296" style="stroke: #000000; stroke-width: 2.0;" width="567.5" x="20" y="433.1641"/><rect fill="#FFFFE0" height="111.2031" style="stroke: none; stroke-width: 1.0;" width="567.5" x="20" y="617.9609"/><rect fill="#FFB6C1" height="140.3359" style="stroke: none; stroke-width: 1.0;" width="587.5" x="10" y="736.1641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="65" y1="40.2969" y2="276.9609"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="65" x2="65" y1="276.9609" y2="317.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="65" y1="317.7656" y2="947.5"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415" x2="415" y1="40.2969" y2="276.9609"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="415" x2="415" y1="276.9609" y2="317.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415" x2="415" y1="317.7656" y2="947.5"/><rect fill="#FEFECE" filter="url(#fixyfwc30owyw)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="30" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="37" y="24.9951">Worker</text><rect fill="#FEFECE" filter="url(#fixyfwc30owyw)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="30" y="946.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="37" y="966.4951">Worker</text><rect fill="#FEFECE" filter="url(#fixyfwc30owyw)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="381" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="388" y="24.9951">Socket</text><rect fill="#FEFECE" filter="url(#fixyfwc30owyw)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="381" y="946.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="388" y="966.4951">Socket</text><rect fill="#FFBBBB" filter="url(#fixyfwc30owyw)" height="67.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="60.5" y="122.5625"/><rect fill="#E9967A" filter="url(#fixyfwc30owyw)" height="575.6016" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="410.5" y="346.8984"/><rect fill="#87CEEB" filter="url(#fixyfwc30owyw)" height="506.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415.5" y="389.0313"/><rect fill="#EEEEEE" filter="url(#fixyfwc30owyw)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="607.5" x="0" y="70.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="607.5" y1="70.8633" y2="70.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="607.5" y1="73.8633" y2="73.8633"/><rect fill="#EEEEEE" filter="url(#fixyfwc30owyw)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="75" x="266.25" y="60.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="56" x="272.25" y="76.3638">发起关闭</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="65.5" x2="112.5" y1="109.5625" y2="109.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="112.5" x2="112.5" y1="109.5625" y2="122.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="71.5" x2="112.5" y1="122.5625" y2="122.5625"/><polygon fill="#A80036" points="81.5,118.5625,71.5,122.5625,81.5,126.5625,77.5,122.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="77.5" y="104.4966">socket_server_close</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="70.5" x2="112.5" y1="156.6953" y2="156.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="112.5" x2="112.5" y1="156.6953" y2="169.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="71.5" x2="112.5" y1="169.6953" y2="169.6953"/><polygon fill="#A80036" points="81.5,165.6953,71.5,169.6953,81.5,173.6953,77.5,169.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="77.5" y="151.6294">send_request('K')</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="70.5" x2="112.5" y1="188.6953" y2="188.6953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="112.5" y1="188.6953" y2="201.6953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="65.5" x2="112.5" y1="201.6953" y2="201.6953"/><polygon fill="#A80036" points="75.5,197.6953,65.5,201.6953,75.5,205.6953,71.5,201.6953" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#EEEEEE" filter="url(#fixyfwc30owyw)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="607.5" x="0" y="225.2617"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="607.5" y1="225.2617" y2="225.2617"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="607.5" y1="228.2617" y2="228.2617"/><rect fill="#EEEEEE" filter="url(#fixyfwc30owyw)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="108" x="249.75" y="214.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="255.75" y="230.7622">关闭/停止连接</text><polygon fill="#A80036" points="403.5,264.9609,413.5,268.9609,403.5,272.9609,407.5,268.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="65.5" x2="409.5" y1="268.9609" y2="268.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="72.5" y="263.895">&lt;&lt;pipe&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="25" x="228" y="301.1714">pipe</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="462.5" y1="333.8984" y2="333.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="462.5" x2="462.5" y1="333.8984" y2="346.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="421.5" x2="462.5" y1="346.8984" y2="346.8984"/><polygon fill="#A80036" points="431.5,342.8984,421.5,346.8984,431.5,350.8984,427.5,346.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="427.5" y="328.8325">ctrl_cmd</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="467.5" y1="376.0313" y2="376.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467.5" x2="467.5" y1="376.0313" y2="389.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426.5" x2="467.5" y1="389.0313" y2="389.0313"/><polygon fill="#A80036" points="436.5,385.0313,426.5,389.0313,436.5,393.0313,432.5,389.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="432.5" y="370.9653">close_socket</text><path d="M10,409.0313 L76,409.0313 L76,416.0313 L66,426.0313 L10,426.0313 L10,409.0313 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="467.4688" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="10" y="409.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="25" y="422.0981">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="91" y="421.2417">[关闭（close）]</text><path d="M20,433.1641 L86,433.1641 L86,440.1641 L76,450.1641 L20,450.1641 L20,433.1641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="296" style="stroke: #000000; stroke-width: 2.0;" width="567.5" x="20" y="433.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="35" y="446.231">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="101" y="445.3745">[数据全部发送完毕]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425.5" x2="467.5" y1="471.4297" y2="471.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467.5" x2="467.5" y1="471.4297" y2="484.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426.5" x2="467.5" y1="484.4297" y2="484.4297"/><polygon fill="#A80036" points="436.5,480.4297,426.5,484.4297,436.5,488.4297,432.5,484.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="432.5" y="466.3638">nomore_sending_data</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425.5" x2="467.5" y1="513.5625" y2="513.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467.5" x2="467.5" y1="513.5625" y2="526.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426.5" x2="467.5" y1="526.5625" y2="526.5625"/><polygon fill="#A80036" points="436.5,522.5625,426.5,526.5625,436.5,530.5625,432.5,526.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="432.5" y="508.4966">force_close</text><path d="M317,539.5625 L317,579.5625 L509,579.5625 L509,549.5625 L499,539.5625 L317,539.5625 " fill="#90EE90" filter="url(#fixyfwc30owyw)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M499,539.5625 L499,549.5625 L509,549.5625 L499,539.5625 " fill="#90EE90" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="323" y="556.6294">此时socket状态为</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="434" y="556.6294">INVALID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="323" y="571.7622">表示连接已完全关闭</text><polygon fill="#A80036" points="76.5,605.9609,66.5,609.9609,76.5,613.9609,72.5,609.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="70.5" x2="414.5" y1="609.9609" y2="609.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="82.5" y="604.895">forward_message(SKYNET_SOCKET_TYPE_CLOSE)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="20" x2="587.5" y1="618.9609" y2="618.9609"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="25" y="629.1714">[数据未发送完]</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="425.5" x2="467.5" y1="653.8984" y2="653.8984"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="467.5" x2="467.5" y1="653.8984" y2="666.8984"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="426.5" x2="467.5" y1="666.8984" y2="666.8984"/><polygon fill="#A80036" points="436.5,662.8984,426.5,666.8984,436.5,670.8984,432.5,666.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="432.5" y="648.8325">continue</text><path d="M305,679.8984 L305,719.8984 L522,719.8984 L522,689.8984 L512,679.8984 L305,679.8984 " fill="#FFFF00" filter="url(#fixyfwc30owyw)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,679.8984 L512,689.8984 L522,689.8984 L512,679.8984 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="311" y="696.9653">此时socket状态为</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="422" y="696.9653">HALFCLOSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="311" y="712.0981">表示连接半关闭</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="10" x2="597.5" y1="737.1641" y2="737.1641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="15" y="747.3745">[停止（shutdown）]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425.5" x2="467.5" y1="772.1016" y2="772.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467.5" x2="467.5" y1="772.1016" y2="785.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426.5" x2="467.5" y1="785.1016" y2="785.1016"/><polygon fill="#A80036" points="436.5,781.1016,426.5,785.1016,436.5,789.1016,432.5,785.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="432.5" y="767.0356">force_close</text><path d="M317,798.1016 L317,838.1016 L509,838.1016 L509,808.1016 L499,798.1016 L317,798.1016 " fill="#90EE90" filter="url(#fixyfwc30owyw)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M499,798.1016 L499,808.1016 L509,808.1016 L499,798.1016 " fill="#90EE90" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="323" y="815.1685">此时socket状态为</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="434" y="815.1685">INVALID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="323" y="830.3013">表示连接已强制关闭</text><polygon fill="#A80036" points="76.5,864.5,66.5,868.5,76.5,872.5,72.5,868.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="70.5" x2="414.5" y1="868.5" y2="868.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="82.5" y="863.4341">forward_message(SKYNET_SOCKET_TYPE_CLOSE)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="425.5" x2="467.5" y1="894.5" y2="894.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="467.5" x2="467.5" y1="894.5" y2="907.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="420.5" x2="467.5" y1="907.5" y2="907.5"/><polygon fill="#A80036" points="430.5,903.5,420.5,907.5,430.5,911.5,426.5,907.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="420.5" x2="462.5" y1="921.5" y2="921.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="462.5" x2="462.5" y1="921.5" y2="934.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="415.5" x2="462.5" y1="934.5" y2="934.5"/><polygon fill="#A80036" points="425.5,930.5,415.5,934.5,425.5,938.5,421.5,934.5" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[fa76b47ab3c18c687f7b0683de72b379]
@startuml
participant Worker
participant Socket

== 发起关闭 ==
Worker -> Worker ++ #FFBBBB: socket_server_close
Worker -> Worker : send_request('K')
return

== 关闭/停止连接 ==
Worker - -> Socket: <<pipe>>
... pipe ...

Socket -> Socket ++ #DarkSalmon: ctrl_cmd
Socket -> Socket ++ #SkyBlue: close_socket

alt #LightPink 关闭（close）
    alt #LightYellow 数据全部发送完毕
        Socket -> Socket: nomore_sending_data
        Socket -> Socket: force_close
        note over Socket #lightgreen: 此时socket状态为 **INVALID**\n表示连接已完全关闭
        Socket - -> Worker: forward_message(SKYNET_SOCKET_TYPE_CLOSE)
    else 数据未发送完
        Socket - -> Socket: continue
        note over Socket #Yellow: 此时socket状态为 **HALFCLOSE**\n表示连接半关闭
    end
else 停止（shutdown）
    Socket -> Socket: force_close
    note over Socket #lightgreen: 此时socket状态为 **INVALID**\n表示连接已强制关闭
    Socket - -> Worker: forward_message(SKYNET_SOCKET_TYPE_CLOSE)
end

return
return
@enduml

PlantUML version 1.2020.20beta11(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>