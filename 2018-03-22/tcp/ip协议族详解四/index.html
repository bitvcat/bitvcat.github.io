<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>TCP/IP协议族详解（四）</title>
        <style>

    html body {
        font-family: 'Mina', sans-serif;
        background-color: #f5f5f5;
    }

    :root {
        --accent: #386890;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mina">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=VT323">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="http://shuimu98.gitHub.io/css/main.css">




 


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/cpp.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lua.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
    

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>


<script>
$(document).ready(function(){
    
  var input = $('#night-mode-toggle');
  var container = $('#bigbody');
  var stat = $('#button-status');
  
  container.toggleClass(localStorage.toggled);
  stat.bootstrapToggle(localStorage.button).change();
  
  input.on('click', function() {
      if (localStorage.toggled != "-nightmode" ) {
          container.toggleClass("-nightmode", true );
          localStorage.toggled = "-nightmode";
          localStorage.button = "on";
       } else {
          container.toggleClass("-nightmode", false );
          localStorage.toggled = "";
          localStorage.button = "off"
       }
  })
});
</script>
 <meta name="generator" content="Hugo 0.45" />
        
        

    
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#000000">
    <link rel="shortcut icon" href="/img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    
    
    <meta property="og:title" content="TCP/IP协议族详解（四）">
    <meta property="og:type" content="article">
      
      <meta name="twitter:card" content="summary">
      <meta name="twitter:image" content="http://shuimu98.gitHub.iofavicon/avatar.jpg" >
      
    <meta property="description" content="这个系列的文章主要详细了解TCP/IP协议族，本篇主要介绍ICMP协议">
    <meta property="og:description" content="这个系列的文章主要详细了解TCP/IP协议族，本篇主要介绍ICMP协议">
    
    <meta name="twitter:creator" content="">
    <meta name="twitter:site" content="">
    
    </head>

    
    
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <body id = "bigbody">
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">TCP/IP协议族详解（四）</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                                <li><a href="/links/">Links</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:shui_mu98@163.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/shuimu98/"><i class="fa fa-github"></i></a></li>
                            
                            <li id="night-mode-toggle">
    <input type="checkbox" id = "button-status"
        data-toggle="toggle"
        data-width = "10"
        data-height = "1"
        data-on="<i class='fa fa-moon-o fa-lg' style='vertical-align:25%'></i>"
        data-off= "<i class='fa fa-sun-o fa-lg' style='vertical-align:25%'></i>"
        data-style="ios"
        data-onstyle = "default">
</li>
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div class="item">

    
    
    

    
      
      

    <h4><a href="/2018-03-22/tcp/ip%E5%8D%8F%E8%AE%AE%E6%97%8F%E8%AF%A6%E8%A7%A3%E5%9B%9B/">TCP/IP协议族详解（四）</a></h4>
    <h5>2018-03-22 - 2 minutes</h5>

    

    
    <a href="/tags/tcp/ip">
        <kbd class="item-tag"> TCP/IP </kbd>
    </a>
    

</div>


    <br> <div class="text-justify">

<p>本系列文章是<strong>教程：</strong><a href="http://study.163.com/course/courseMain.htm?courseId=1003343002">TCP、IP协议族详解</a>的学习笔记。</p>

<p>该系列大概分为下面几个部分：</p>

<ul>
<li>1、TCP/IP协议4层结构以及每层的作用</li>
<li>2、IP协议详解</li>
<li>3、ARP协议和RARP协议详解</li>
<li>4、ICMP协议详解</li>
<li>5、TCP协议详解</li>
<li>6、UDP协议详解</li>
</ul>

<p>本文主要介绍TCP/IP网络体系中网络层的ICMP协议。</p>

<h2 id="1-ip协议的缺点">1、IP协议的缺点</h2>

<ul>
<li>无差错报告和差错纠正机制</li>
<li>缺少一种为主机和管理查询的机制</li>
</ul>

<p>例如：当IP数据报在网络中超过了它的TTL，那么路由器就会将这个数据报丢弃，但是没有对这个丢弃操作返回错误报告。</p>

<p>为了弥补IP协议的这些缺点，所以就产生了ICMP协议。需要注意的是：<strong>ICMP没有纠正错误的机制</strong>。</p>

<h2 id="2-icmp协议的数据封装格式">2、ICMP协议的数据封装格式</h2>

<p>它的大概封装格式如下：
<img src="/images/posts/tcp-ip/icmp-head-1.png" alt="ICMP的封装" /></p>

<p>ICMP本身是网络层协议。但是，<strong>它的报文不是如设想的那样直接传送给数据链路层</strong>，实际上，ICMP报文首先<strong>封装成IP数据报</strong>，然后再传送给下一层。在IP数据报中的协议字段值是1就表示其IP数据是ICMP报文。通过抓包可以证实这一点。</p>

<p>1、通过<code>ping www.baidu.com</code>命令，使计算机产生ICMP报文；<br />
2、通过wireshark抓包，筛选ICMP协议，此时抓包的结果如下图所示：</p>

<p><img src="/images/posts/tcp-ip/icmp-wireshark-1.png" alt="ICMP的封装" /></p>

<h2 id="3-icmp报文种类">3、ICMP报文种类</h2>

<h3 id="差错报告报文">差错报告报文</h3>

<p>可以理解成是错误信息error，它总是把差错报告返回给原始的数据源。常用的错误类型有：</p>

<ul>
<li>类型3：终点不可达，例如：无法到达目的地，可能是硬件错误、软件设置错误等等原因导致</li>
<li>类型4：源点抑制，例如：发送方发送速率太快，但是某个路由器接受速率过慢，那么这个路由器就会返回一个ICMP，通知发送方速率要慢一点</li>
<li>类型5：路由重定向，例如：当路由器发现数据报走的不是最佳路由，就会返回一个ICMP报告，让发送方下次不要走这里了</li>
<li>类型11：超时，例如：发生了路由环路，从而导致TTL变为0值</li>
<li>类型12：参数问题，例如：数据报的首部被篡改或者丢失</li>
</ul>

<p>我们使用<code>tracert www.baidu.com</code>这个命令，然后抓一些ICMP包，如下图，可以看到很多黑色的结果，即差错报告。
<img src="/images/posts/tcp-ip/icmp-wireshark-2.png" alt="ICMP的差错报告" /></p>

<p><strong>差错报文的要点：</strong></p>

<ul>
<li>对于携带ICMP差错报文的数据报，不再产生ICMP差错报文</li>
<li>对于分片的数据报，如果不是<strong>第一个分片</strong>，则不产生ICMP差错报文</li>
<li>对于具有多播地址（224.0.0.0-239.255.255.255）的数据报，不产生ICMP差错报文</li>
<li>对于具有特殊地址如（127.0.0.0或0.0.0.0）的数据报，不产生ICMP
差错报文</li>
</ul>

<h3 id="查询报文">查询报文</h3>

<p>常用的类型有：</p>

<ul>
<li>类型8或者0：返回请求或回到，例如常用的<code>ping</code>命令</li>
<li>类型13或14：时间戳请求或回答，注意：需要两方的时间必须与标准时间同步</li>
<li>类型17或18：地址码（掩码）请求或回答，不太常用（过时）</li>
<li>类型10或9：路由器查询通告</li>
</ul>

<h2 id="4-icmp头部格式">4、ICMP头部格式</h2>

<p>ICMP两种报文种类有着不同的头部格式，但区别不大，前4个字节是一样的，不同的只有后面4个字节。</p>

<h3 id="查询报文头部格式">查询报文头部格式</h3>

<p>ICMP查询报文头部格式如下，主要包括两个部分：8byte+32byte的数据。格式如下图：
<img src="/images/posts/tcp-ip/icmp-head-2.png" alt="ICMP的查询报文头部格式" /></p>

<p>通过抓包证实一下：<br />
1、运行<code>ping www.baidu.com</code>，开始抓包<br />
2、筛选ICMP协议包，结果如下：
<img src="/images/posts/tcp-ip/icmp-wireshark-3.png" alt="ICMP抓包结果" />
3、字段解释：</p>

<ul>
<li>第1个字节：值为08，表示这是一个查询报文</li>
<li>第2个字节：值为00</li>
<li>第3、4个字节：值为0x4d14，表示头部校验和</li>
<li>第5、6个字节：值为0x0001，注意：这里要分大端和小端格式，一般windows和linux都是小端，所以，这里应该看：<code>Identifier(LE):256(0x0100)</code></li>
<li>第7、8个字节：值为0x4700，同上，也需要分大小端。</li>
<li>后面的32个字节为测试数据</li>
</ul>

<h3 id="差错报告报文头部格式">差错报告报文头部格式</h3>

<p>ICMP差错报文头部格式如下（通用格式），这里<strong>需要注意</strong>的一点是，差错报告报文的格式除了前4个字节，后面的字节所对应的意义是根据<strong>type值</strong>和<strong>code值</strong>发生变化的。</p>

<p><img src="/images/posts/tcp-ip/icmp-head-3.png" alt="ICMP的差错报文头部格式" /></p>

<p>通过抓包证实一下：<br />
1、运行<code>tracert www.baidu.com</code>，开始抓包（注意：这里用的是<strong>tracert命令</strong>）<br />
2、筛选ICMP协议包，结果如下（后4个字节全部为0）：
<img src="/images/posts/tcp-ip/icmp-wireshark-4.png" alt="ICMP抓包结果" /></p>

<p>关于查询报文和差错报文的type和code字段所代表的具体信息，这里不做详细的介绍，如果需要，可以查看本教程的课件。</p>

<h2 id="5-ping命令使用详解">5、ping命令使用详解</h2>

<p><code>ping</code>命令是基于ICMP的查询报文，分为回送请求和回送应答，<strong>请求类型为8，应答类型为0</strong>。</p>

<p>现在我使用<code>ping www.baidu.com</code>命令 （windows 10系统），得到下面的结果：</p>

<pre><code>C:\Windows\System32&gt;ping www.baidu.com

正在 Ping www.a.shifen.com [14.215.177.39] 具有 32 字节的数据:
来自 14.215.177.39 的回复: 字节=32 时间=7ms TTL=54
来自 14.215.177.39 的回复: 字节=32 时间=8ms TTL=54
来自 14.215.177.39 的回复: 字节=32 时间=8ms TTL=54
来自 14.215.177.39 的回复: 字节=32 时间=7ms TTL=54

14.215.177.39 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 7ms，最长 = 8ms，平均 = 7ms
</code></pre>

<p>详细介绍下上面的过程：
1. 首先通过dns服务，将域名解析成IP地址，也就是上面的<code>www.a.shifen.com [14.215.177.39]</code>
2. 然后ping命令发送一个带有32字节数据的ICMP请求包，收到回复后显示结果，也就是上面的<code>来自 14.215.177.39 的回复: 字节=32 时间=7ms TTL=54</code>，</p>

<pre><code>- 其中字节表示测试数据长度（可以通过-l参数指定测试数据的大小，例如`ping -l 1024 www.baidu.com`）
- 时间表示包的**往返时间（一去一来所用的时间）**
- TTL为54（请求包的TTL为64），也就是回复的包进过了10个路由器。
</code></pre>

<p>通过抓包，可以证实上面的流程（我使用的是<code>ping -l 1024 www.baidu.com</code>）。
<img src="/images/posts/tcp-ip/ping-wireshark-1.png" alt="ping抓包结果1" />
<img src="/images/posts/tcp-ip/ping-wireshark-2.png" alt="ping抓包结果2" /></p>

<p>注意：上图的Length是1066，也就是包的总长度是1066byte。那么这个1066是怎么算出来的？1066 = 1024byte(ICMP数据长度)+ 8byte(ICMP头部长度)+ 20byte(IP头部)+14byte(以太网头部)。</p>

<h2 id="6-tracert命令详解">6、tracert命令详解</h2>

<p>linux下的命令是<code>traceroute</code>，windows下使用   <code>tracert</code>。tracert可以解决ping的不足，它能定位到某一个具体的某一台设备。</p>

<p>先介绍一下tracert命令的工作原理：命令发起方会<strong>依次</strong>对到达目的主机的路由路径中的路由节点发起<strong>一轮</strong>ping请求，<strong>三次ping为一轮</strong>，每一轮的TTL值加以（第一轮为1，第二轮为2&hellip;依次类推），逐个检查这条路由路径上每个路由节点。最核心的一句话就是：它就是利用了路由器对TTL为0的包进行丢弃后，返回给源主机一个ICMP差错报告报文这一点来实现的。</p>

<p>大概流程如下图所示：
<img src="/images/posts/tcp-ip/tracert-1.png" alt="tracert流程" /></p>

<p>下面通过一个实例来使用一下这个命令，并通过抓包，验证上面描述的流程。</p>

<p>打开CMD（win 10系统），运行命令<code>tracert www.qq.com</code>，等待一段时间，得到下面的结果。</p>

<pre><code>C:\Windows\System32&gt;tracert www.qq.com

通过最多 30 个跃点跟踪
到 www.qq.com [59.37.96.63] 的路由:

  1    &lt;1 毫秒   &lt;1 毫秒   &lt;1 毫秒 192.168.2.1
  2     1 ms     1 ms     2 ms  192.168.3.1
  3     1 ms     1 ms     1 ms  192.168.1.1
  4     3 ms     9 ms     6 ms  100.64.0.1
  5     8 ms     6 ms     6 ms  218.19.193.181
  6     *        *        *     请求超时。
  7     7 ms    18 ms     6 ms  119.147.223.122
  8     *        *        *     请求超时。
  9     9 ms     8 ms     8 ms  14.17.2.62
 10     *        *        *     请求超时。
 11     *        *        *     请求超时。
 12     *        *        *     请求超时。
 13     *        *        *     请求超时。
 14     *        *        *     请求超时。
 15     8 ms     8 ms    11 ms  59.37.96.63

跟踪完成。
</code></pre>

<p>第一列是路由器的编号，也可以算作是请求包的TTL值，第2到第4列，分别表示这一轮的三次ping所花费的时间（往返时间，*表示这个路由器没有响应，但是不能确定就是这个路由器有问题，可能是路由器设置了不处理ICMP协议），第5列表示这一轮的目的路由节点的IP地址。</p>

<p>跟踪结束后，停止抓包，通过分析抓包结果，与上面的工作原理是完全符合的。</p>

<p><img src="/images/posts/tcp-ip/tracert-2.png" alt="tracert抓包1" />
<img src="/images/posts/tcp-ip/tracert-3.png" alt="tracert抓包2" /></p>
</div>

    

    <hr>
    <div class="text-justify">
    
        <div id="comments-gitment"></div>
            <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
            <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
            <script type="text/javascript">
            const gitment = new Gitment({
              id: '2018-03-22 00:00:00 \x2b0000 UTC',
              title: 'TCP\/IP协议族详解（四）',
              link: decodeURI(location.href),
              desc: '本系列文章是教程：TCP、IP协议族详解的学习笔记。\n该系列大概分为下面几个部分：\n 1、TCP\/IP协议4层结构以及每层的作用 2、IP协议详解 3、ARP协议和RARP协议详解 4、ICMP协议详解 5、TCP协议详解 6、UDP协议详解  本文主要介绍TCP\/IP网络体系中网络层的ICMP协议。\n1、IP协议的缺点  无差错报告和差错纠正机制 缺少一种为主机和管理查询的机制  例如：当IP数据报在网络中超过了它的TTL，那么路由器就会将这个数据报丢弃，但是没有对这个丢弃操作返回错误报告。\n为了弥补IP协议的这些缺点，所以就产生了ICMP协议。需要注意的是：ICMP没有纠正错误的机制。\n2、ICMP协议的数据封装格式 它的大概封装格式如下： ICMP本身是网络层协议。但是，它的报文不是如设想的那样直接传送给数据链路层，实际上，ICMP报文首先封装成IP数据报，然后再传送给下一层。在IP数据报中的协议字段值是1就表示其IP数据是ICMP报文。通过抓包可以证实这一点。\n1、通过ping www.baidu.com命令，使计算机产生ICMP报文；\n2、通过wireshark抓包，筛选ICMP协议，此时抓包的结果如下图所示：\n3、ICMP报文种类 差错报告报文 可以理解成是错误信息error，它总是把差错报告返回给原始的数据源。常用的错误类型有：\n 类型3：终点不可达，例如：无法到达目的地，可能是硬件错误、软件设置错误等等原因导致 类型4：源点抑制，例如：发送方发送速率太快，但是某个路由器接受速率过慢，那么这个路由器就会返回一个ICMP，通知发送方速率要慢一点 类型5：路由重定向，例如：当路由器发现数据报走的不是最佳路由，就会返回一个ICMP报告，让发送方下次不要走这里了 类型11：超时，例如：发生了路由环路，从而导致TTL变为0值 类型12：参数问题，例如：数据报的首部被篡改或者丢失  我们使用tracert www.baidu.com这个命令，然后抓一些ICMP包，如下图，可以看到很多黑色的结果，即差错报告。 差错报文的要点：\n 对于携带ICMP差错报文的数据报，不再产生ICMP差错报文 对于分片的数据报，如果不是第一个分片，则不产生ICMP差错报文 对于具有多播地址（224.0.0.0-239.255.255.255）的数据报，不产生ICMP差错报文 对于具有特殊地址如（127.0.0.0或0.0.0.0）的数据报，不产生ICMP 差错报文  查询报文 常用的类型有：\n 类型8或者0：返回请求或回到，例如常用的ping命令 类型13或14：时间戳请求或回答，注意：需要两方的时间必须与标准时间同步 类型17或18：地址码（掩码）请求或回答，不太常用（过时） 类型10或9：路由器查询通告  4、ICMP头部格式 ICMP两种报文种类有着不同的头部格式，但区别不大，前4个字节是一样的，不同的只有后面4个字节。\n查询报文头部格式 ICMP查询报文头部格式如下，主要包括两个部分：8byte\x2b32byte的数据。格式如下图： 通过抓包证实一下：\n1、运行ping www.baidu.com，开始抓包\n2、筛选ICMP协议包，结果如下： 3、字段解释：\n 第1个字节：值为08，表示这是一个查询报文 第2个字节：值为00 第3、4个字节：值为0x4d14，表示头部校验和 第5、6个字节：值为0x0001，注意：这里要分大端和小端格式，一般windows和linux都是小端，所以，这里应该看：Identifier(LE):256(0x0100) 第7、8个字节：值为0x4700，同上，也需要分大小端。 后面的32个字节为测试数据  差错报告报文头部格式 ICMP差错报文头部格式如下（通用格式），这里需要注意的一点是，差错报告报文的格式除了前4个字节，后面的字节所对应的意义是根据type值和code值发生变化的。',
              owner: 'shuimu98',
              repo: 'shuimu98.github.io',
              oauth: {
                client_id: 'af5065a1372570c7babc',
                client_secret: '3bd955012d21847887f0d3d4f9ea3c2cbc2b7e10'
              }
            })
            gitment.render('comments-gitment')
            </script>
    
    </div>

</main>

        <footer id = "bigfooter">
            <div style = "padding:15px;">
                <p>Powered by <a href="https://gohugo.io">Hugo</a>. Themed by <a href="https://github.com/nathancday/min_night">min_night</a>.
                </p>
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/"
                title="Creative Commons Attribution 4.0 International license">
                <i class="fa fa-creative-commons" aria-hidden="true"></i> Attribution 4.0 International license
                </a>
            </div>
        </footer>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());
          gtag('config', '');
        </script>
       
    </body>

</html>

