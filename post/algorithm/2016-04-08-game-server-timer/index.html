<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>时间轮定时器 - Domi●Cat</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="DomiCat" />
  <meta name="description" content="定时器实现一般常见的有两种方式： 时间轮（time_wheel） 最小堆 就我自己的了解，使用时间轮的开源项目有：云风的skynet、陈硕的mud" />

  <meta name="keywords" content="Hugo, theme, DomiCat" />






<meta name="generator" content="Hugo 0.44" />


<link rel="canonical" href="http://shuimu98.github.io/post/algorithm/2016-04-08-game-server-timer/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="时间轮定时器" />
<meta property="og:description" content="定时器实现一般常见的有两种方式： 时间轮（time_wheel） 最小堆 就我自己的了解，使用时间轮的开源项目有：云风的skynet、陈硕的mud" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://shuimu98.github.io/post/algorithm/2016-04-08-game-server-timer/" />
















<meta itemprop="name" content="时间轮定时器">
<meta itemprop="description" content="定时器实现一般常见的有两种方式： 时间轮（time_wheel） 最小堆 就我自己的了解，使用时间轮的开源项目有：云风的skynet、陈硕的mud">



<meta itemprop="wordCount" content="1955">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="时间轮定时器"/>
<meta name="twitter:description" content="定时器实现一般常见的有两种方式： 时间轮（time_wheel） 最小堆 就我自己的了解，使用时间轮的开源项目有：云风的skynet、陈硕的mud"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">DomiCat</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">DomiCat</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">时间轮定时器</h1>

      <div class="post-meta">
        <span class="post-time"> 0001-01-01 </span>
        
        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#时间轮算法">时间轮算法</a></li>
<li><a href="#不分层的时间轮">不分层的时间轮</a></li>
<li><a href="#分层的时间轮">分层的时间轮</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<p>定时器实现一般常见的有两种方式：</p>

<ul>
<li>时间轮（time_wheel）</li>
<li>最小堆</li>
</ul>

<p>就我自己的了解，使用时间轮的开源项目有：云风的skynet、陈硕的muduo；而经典的libevent库则使用的是最小堆。</p>

<!-- more -->

<p>分别解释下最小堆和时间轮的简单概念：</p>

<ul>
<li>最小堆：最小堆是一个经过排序的完全二叉树,除开根节点，其他任意节点的值都要小于它两个左右孩子的值。</li>
</ul>

<p>另外关于二叉树的分类，我会另外单独写个笔记整理一下。</p>

<blockquote>
<p>关于完全二叉树，一个n层的二叉树，除了第n-1层是满的（没有空位），第n层右边可以满可以不满，但是从左到右不能出现空位。可使用广度遍历来判断是否是完全二叉树。</p>
</blockquote>

<ul>
<li>时间轮：可以直接拿我们生活中的手边做例子，手表一共有三个分级，时钟、分针和秒针，我们把秒针的一个刻度称为一个tick，秒针每走一圈，分针就移动一个刻度，
时间轮的原理就跟手表的模型是一样的。</li>
</ul>

<h3 id="时间轮算法">时间轮算法</h3>

<p>时间轮 (Timing-Wheel) 算法类似于一以恒定速度旋转的左轮手枪，枪的撞针则撞击枪膛，如果枪膛中有子弹，则会被击发。下面我将由简入深介绍基于时间轮实现的定时器。</p>

<p>时间轮算法的复杂程度跟你的分级层数有关，最简单的就是只有一轮，复杂一点的就是分层的时间轮，比如Hierarchy 时间轮（也就是linux系统下的时间轮实现方式）。</p>

<h3 id="不分层的时间轮">不分层的时间轮</h3>

<p>不分层的时间轮是最简单，也是很容易理解的时间轮模型了：</p>

<blockquote>
<p>假设有个N个槽（tick)的轮子，随着时间推进，每走一个tick的时间，指针指向到槽也往前推进一格，直到一个轮所有的槽都执行完毕。</p>
</blockquote>

<p>下图描述了一个不分层的时间时间轮模型：</p>

<p><img src="/images/posts/timewheel/time_wheel_1.jpg" alt="简单时间轮" /></p>

<p>我们可以根据上面的模型，实现一个简单实用的时间轮定时器，一般的场景一层的时间轮已经够用了，比如游戏服务器，很少用到时间跨度非常大的定时器。
根据我自己的项目经验，目前我们的游戏服务器内部采用的就是简单的不分层时间轮，模型如下：</p>

<pre><code>							|-- user_t[0]
			|-slot_t[0]	---	|-- ……
			|-slot_t[1]		|-- user_t[n]
tw.slots  = |-……
			|-……
			|-slot_t[6400-1]

tw.lslot  = 留一个槽，存放那些超时时间大于一轮的超时事件
</code></pre>

<p>上面模型中，slots表示时间轮的槽位，每个槽位里面可能有多个定时器任务，用一个链表来存放这些定时器任务。</p>

<p>该时间轮一共有6400个刻度，一个tick为10毫秒，那么每次走完一个转盘需要的时间等于 <code>6400 * 10ms</code>,即64s，差不多一分钟的时间走一轮。</p>

<p>用lua表述下这个模型，大概如下：</p>

<pre><code class="language-lua">tick = 10 ms    -- tick
slotlen = 6000  -- 刻度数量

--下面用lua的table表示这个时间轮的数据结构：
time_wheel = {
	slots = {
		[1] = {timeobj1,timeobj2,…} -- 刻度1上的定时对象
		[2] = {timeobj1,timeobj2,…} -- 刻度2上的定时对象
	},
	lslot = {t1,t2,…}   -- 这里存放的是tick超过一圈的定时对象
	curTick = 0,        -- 当前走了多少个tick  
}

timeObj = {
	tick=10,        -- 表示这个定时对象需要10个tick，
	tickout = 1230, -- 表示超时的tick，即当定时器tick了1230次后，就触发超时事件
}
</code></pre>

<blockquote>
<p>ps：</p>

<p>关于curTick,这里必须使用无符号，因为curTick是定时器每tick一次就会自增1，而无符号没有溢出的问题，这样可以满足定时器tick到无符号整数能容纳的最大数之后也能继续正确运行。
举个例子：如果我们有用无符号的32位int表示curTick，那么当curTick一直自增到 0xFFFFFFFF(4294967295)，那么当下一次tick是，curTick又会复位到0，新的tick又会继续运行。</p>
</blockquote>

<p><strong>处理下一轮</strong></p>

<p>当一个时间轮跑完一整轮后，要把超过一轮的定时器任务取出来重新分配格子。</p>

<p>例如：有一个循环为 <code>5个</code> Tick 时间轮，当在tick为3的时候插入一个5tick后的定时器任务A，因为3+5=8tick已经超过时间轮的大小，所以，A必定在一轮循环完后，再取出来分配新的格子。
当tick=5时，一轮结束，然后取出任务A，此时分配的格子索引为：<code>8%5=3</code>。</p>

<h3 id="分层的时间轮">分层的时间轮</h3>

<p>当我们在一些定时跨度比较大的场景时，上面的单层时间轮可能不再满足你的需求（当然是可以继续工作，但是有更好的办法）。
此时我们需要考虑分层，就好比现实生活中的手表，它分层了时、分、秒三个不同粒度的层级，这样可以节省内存空间。</p>

<p>这里分层的时间轮，并不是按照手表的粒度来分，而是用了另一种方式：</p>

<blockquote>
<p>用一个32bit的无符号整型表示一个时间轮的范围，也就是说它能够支持2^32个tick（也就是0xFFFFFFFF），把它分层为5组，每组的粒度分别为：</p>

<p>256,64,64,64,64，也就是 <code>256*64*64*64*64=2^32</code>，时间轮就只需要 <code>256+64*4=512</code>个桶，比上面未分层的时间轮数组更小。</p>
</blockquote>

<p>这是我自己用go实现的 <a href="https://github.com/shuimu98/domi-lab/blob/master/golang/time_wheel.go">time_wheel</a>，比较简单，还有很多需要优化的细节，但是基础都实现了。</p>

<p>当然，上面的这种实现是比较简单的，但是对于游戏服务器来说，这个简单的时间轮已经够用了，如果说想实现更高端的，可以参考<a href="https://github.com/cloudwu/skynet/blob/master/skynet-src/skynet_timer.c">云风skynet里面的时间轮实现</a>。</p>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title"></span>
    <span class="item-content">DomiCat</span>
  </p>
  <p class="copyright-item">
    <span class="item-title"></span>
    <span class="item-content">0001-01-01</span>
  </p>
  
  
</div>

    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/wiki/2016-08-27-my-working-env/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">我的工作环境分享</span>
            <span class="prev-text nav-mobile"></span>
          </a>
        
      </nav>
    </footer>
  </article>
        </div>
        
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
  <a href="http://shuimu98.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    %!(EXTRA string=<a class="hexo-link" href="https://gohugo.io">Hugo</a>)
  </span>
  <span class="division">|</span>
  <span class="theme-info">
     - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2014 - 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">DomiCat</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>








</body>
</html>
