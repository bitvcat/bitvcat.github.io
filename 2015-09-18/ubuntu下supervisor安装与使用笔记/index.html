<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ubuntu下supervisor安装与使用笔记</title>
        <style>

    html body {
        font-family: 'Mina', sans-serif;
        background-color: #f5f5f5;
    }

    table {
        max-width: 100%;
        margin: 10px 0;
        border-spacing: 0;
        box-shadow: 4px 4px 3px rgba(0,0,0,.125);
    }

    table thead {
      background: #386890;
    }

    table th, td {
        padding: 5px 15px;
        border: 1px solid black;
    }

    table tr:hover {
        background-color: #f1f1A0;
    }

    :root {
        --accent: #386890;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mina">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=VT323">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="http://shuimu98.gitHub.io/css/main.css">




 


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/cpp.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lua.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
    

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>


<script>
$(document).ready(function(){
    
  var input = $('#night-mode-toggle');
  var container = $('#bigbody');
  var stat = $('#button-status');
  
  container.toggleClass(localStorage.toggled);
  stat.bootstrapToggle(localStorage.button).change();
  
  input.on('click', function() {
      if (localStorage.toggled != "-nightmode" ) {
          container.toggleClass("-nightmode", true );
          localStorage.toggled = "-nightmode";
          localStorage.button = "on";
       } else {
          container.toggleClass("-nightmode", false );
          localStorage.toggled = "";
          localStorage.button = "off"
       }
  })
});
</script>
 <meta name="generator" content="Hugo 0.45.1" />
        
        

    
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#000000">
    <link rel="shortcut icon" href="/img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    
    
    <meta property="og:title" content="ubuntu下supervisor安装与使用笔记">
    <meta property="og:type" content="article">
      
      <meta name="twitter:card" content="summary">
      <meta name="twitter:image" content="http://shuimu98.gitHub.iofavicon/avatar.jpg" >
      
    <meta property="description" content="">
    <meta property="og:description" content="">
    
    <meta name="twitter:creator" content="">
    <meta name="twitter:site" content="">
    
    </head>

    
    
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <body id = "bigbody">
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">ubuntu下supervisor安装与使用笔记</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                                <li><a href="/links/">Links</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:shui_mu98@163.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/shuimu98/"><i class="fa fa-github"></i></a></li>
                            
                            <li id="night-mode-toggle">
    <input type="checkbox" id = "button-status"
        data-toggle="toggle"
        data-width = "10"
        data-height = "1"
        data-on="<i class='fa fa-moon-o fa-lg' style='vertical-align:25%'></i>"
        data-off= "<i class='fa fa-sun-o fa-lg' style='vertical-align:25%'></i>"
        data-style="ios"
        data-onstyle = "default">
</li>
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div class="item">

    
    
    

    
    
      

    <h4><a href="/2015-09-18/ubuntu%E4%B8%8Bsupervisor%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">ubuntu下supervisor安装与使用笔记</a></h4>
    <h5>2015-09-18 - 3 minutes</h5>

    

    
    <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">
        <kbd class="item-tag"> 环境搭建 </kbd>
    </a>
    

</div>


    <br> <div class="text-justify">

<h3 id="1-supervisor-介绍">1、supervisor 介绍</h3>

<p>它是个什么东东？用来干嘛的？<br />
supervisor是linux下的进程管理工具，python编写。用来监控进程的运行。比如说你要一直运行进程A，使用supervisor后，如果A进程崩掉了，
或者意外被kill了，supervisor可以快速帮你重新启动A，当然还有其他功能。待我后面一一挖掘。</p>

<!-- more -->

<h3 id="2-supervisor-安装">2、supervisor 安装</h3>

<p><strong>安装环境：</strong></p>

<blockquote>
<p>ubuntu 14.04<br />
python 2.7.6</p>
</blockquote>

<p>这里我选择在线安装，可以参考<a href="http://supervisord.org/installing.html">官网的文档</a>， 使用Setuptools在线安装。需要先安装Setuptools，这里，我尝试了两种方式安装：</p>

<p>（1）、手动下载 ez_setup.py,<a href="https://pypi.python.org/pypi/setuptools#downloads">下载地址</a>,然后使用命令：</p>

<pre><code>root@st-B85M-DS3H:~/tools# python ez_setup.py 
</code></pre>

<p>如果安装成功，会显示：</p>

<pre><code>Installed /usr/local/lib/python2.7/dist-packages/setuptools-18.2-py2.7.egg
Processing dependencies for setuptools==18.2
Finished processing dependencies for setuptools==18.2 
</code></pre>

<p>（2）、ubuntu下，直接使用apt-get安装</p>

<pre><code>root@st-B85M-DS3H:~/Projects# sudo apt-get install python-setuptools
</code></pre>

<p>如果安装成功，最后会显示：</p>

<pre><code>Unpacking python-setuptools (3.3-1ubuntu2) ...
Setting up python-pkg-resources (3.3-1ubuntu2) ...
Setting up python-setuptools (3.3-1ubuntu2) ...
</code></pre>

<p>输入命令：</p>

<pre><code>root@st-B85M-DS3H:~/Projects# easy_install --help
</code></pre>

<p>检查是否安装成功。</p>

<p>安装好setuptools之后，使用命令<code>easy_install supervisor</code> ,开始安装supervisor。<br />
当然，也可以下载源码，解压后，使用命令 <code>python setup.py install</code>来进行安装。</p>

<h3 id="3-supervisor-配置">3、supervisor 配置</h3>

<p>关于详细的配置，可以参<a href="http://www.2cto.com/os/201503/378878.html">考这篇文章</a>。</p>

<p>创建默认的配置文件，<code>echo_supervisord_conf  &gt;/etc/supervisord.conf</code>，</p>

<p>supervisor的配置文件路径： <code>vim /etc/supervisord.conf</code>，可以看到这里已经很多默认配置，只不过大部分都注释掉了。如果添加一个要监视的进程，可以再配置文件最后添加如下配置：</p>

<pre><code>;command=/bin/echo;         supervisor启动时将要开启的进程。相对或绝对路径均可。若是相对路径则会从supervisord的$PATH变中查找。命令可带参数。
;priority=999                   指明进程启动和关闭的顺序。低优先级表明进程启动时较先启动关闭时较后关闭。高优先级表明进程启动时启动时较后启动关闭时较先关闭。
;autostart=true                 是否随supervisord启动而启动
;autorestart=true               进程意外退出后是否自动重启
;startsecs=10                   进程持续运行多久才认为是启动成功
;startretries=3                 重启失败的连续重试次数
;exitcodes=0,2                  若autostart设置为unexpected且监控的进程并非因为supervisord停止而退出，那么如果进程的退出码不在exitcode列表中supervisord将重启进程
;stopsignal=QUIT                杀进程的信号
;stopwaitsecs=10                向进程发出stopsignal后等待OS向supervisord返回SIGCHILD 的时间。若超时则supervisord将使用SIGKILL杀进程
</code></pre>

<h3 id="4-启动和关闭-supervisord">4、启动和关闭 supervisord</h3>

<p>（1）、启动</p>

<p>使用命令 <code>supervisord -c /etc/supervisord.conf</code>来启动，现在，来检查是否启动成功。</p>

<pre><code>root@st-B85M-DS3H:~# ps -aux|grep supervisord
root      2562  0.0  0.1  66132 12928 ?        Ss    9月16   0:19 /usr/bin/python /usr/local/bin/supervisord -c /etc/supervisord.conf
root     17791  0.0  0.1 182920 10396 pts/21   Sl+  21:24   0:00 vim /etc/supervisord.conf
root     17836  0.0  0.0  15940   960 pts/20   S+   21:32   0:00 grep --color=auto supervisord
</code></pre>

<p>可以看到，我已经成功启动了supervisor。之后所有的操作都可以用<code>supervisorctl</code>，具体参数<code>supervisorctl --help</code></p>

<p>（2）、关闭</p>

<pre><code>supervisorctl shutdown  
</code></pre>

<p>或</p>

<pre><code>username=user
passwd=123
/usr/local/bin/supervisorctl -u{$username} -p{$passwd} stop all
/usr/local/bin/supervisorctl -u{$username} -p{$passwd} shutdown
</code></pre>

<h3 id="5-使用-supervisor">5、使用 supervisor</h3>

<p>现在我添加一个要守护的进程：</p>

<pre><code>[program:domi-admin]
command =/root/Projects/gopath/src/domi-admin/domi-admin
autostart=true
autorestart=true
startsecs=3 
</code></pre>

<p>保存，重启<code>supervisorctl restart</code>。</p>

<p>输入 <code>supervisorctl</code>,会显示出当前正在监视的进程，例如：</p>

<pre><code>root@st-B85M-DS3H:~# supervisorctl 
domi-admin                       RUNNING   pid 17969, uptime 0:04:40
supervisor&gt; ?

default commands (type help &lt;topic&gt;):
=====================================
add    clear  fg        open  quit    remove  restart   start   stop  update 
avail  exit   maintail  pid   reload  reread  shutdown  status  tail  version

supervisor&gt; 
</code></pre>

<p>可以使用上面的命令进行更多的操作，例如 <code>tail -f domi-admin</code>，可以实时查看打印信息。</p>

<pre><code>root@st-B85M-DS3H:~# supervisorctl 
domi-admin                       RUNNING   pid 17969, uptime 0:06:58
supervisor&gt; tail -f domi-admin 
==&gt; Press Ctrl-C to exit &lt;==
读取的服务器个数:  16
2015/09/17 21:42:48 [app.go:103] [I] http server Running on :8080
2015/09/17 21:42:55 [router.go:845] [D] | GET        | /broadcast/add                           | 1.658723ms       | match      | /broadcast/add                           | 
2015/09/17 21:42:55 [router.go:845] [D] | GET        | /login                                   | 33.091105ms      | match      | /login                                   | 
</code></pre>

<h3 id="6-在浏览器中查看">6、在浏览器中查看</h3>

<p>这个功能很实用，而且配置非常简单，打开配置文件，找到[inet_http_server]节点，把前面的注释 &ldquo;;&rdquo; 去掉，</p>

<pre><code>[inet_http_server]         ; inet (TCP) server disabled by default                                                                                                                                      
port=192.168.1.112:9001        ; (ip_address:port specifier, *:port for all iface)
username=user              ; (default is no username (open server))
password=123               ; (default is no password (open server))
</code></pre>

<p>重启，然后在浏览器中输入 192.168.1.112:9001，就可以很方便的操作了。来一张图。如果不想每次都输入密码，可以注释掉username和password。</p>

<p><img src="/images/posts/supervisor.png" alt="pic" /></p>

<h3 id="7-遇到的问题">7、遇到的问题</h3>

<p>（1）、Cannot open an HTTP server</p>

<pre><code>root@VM-169-246-ubuntu:~/Projects/sti/src/domi-admin# supervisord -c /etc/supervisord.conf 
Error: Cannot open an HTTP server: socket.error reported errno.EADDRNOTAVAIL (99)
For help, use /usr/local/bin/supervisord -h
</code></pre>

<p>此问题是开启浏览器查看产生的，后面查了好久没有解决，后面发现这台远程机器有一个内网ip还一个公网ip，而在配置中，port 用了公网ip，想了想，把port配置内网ip，然后用nginx反向代理到内网ip。</p>

<p>具体想要达到的目的：</p>

<p><strong>服务器A</strong>，有一个公网ip和一个内网ip，内网ip可以和内部的其他服务器通讯，在<strong>服务器A</strong>修改nginx配置，监听9002 端口（supervisor 监听的9001）,我需要在浏览器中输入公网ip:9002，能够反向代理到服务器A上的9001端口，从而达到在浏览器中操作supervisor的目的。</p>

<p>具体配置如下：</p>

<pre><code>server{
        listen 9002;          
        server_name localhost;
        charset utf-8;
        location / {
                proxy_redirect off;
                proxy_set_header Host $host:9002;   #注意：这里要加上ngnix要监听的端口号
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://10.251.169.246:9001;
        }
 }
</code></pre>

<p>reload配置并重启，</p>

<pre><code>root@VM-169-246-ubuntu:/etc/nginx# service nginx reload  
    * Reloading nginx configuration nginx    [ OK ] 
root@VM-169-246-ubuntu:/etc/nginx# service nginx restart
    * Restarting nginx nginx                 [ OK ]     
</code></pre>

<p>在浏览器中输入 119.x.x.xxx:9002,然后发现死活进不去，检查 9001 和 9002端口，都显示正常。</p>

<pre><code>root@VM-169-246-ubuntu:/etc/nginx# netstat -anp|grep 9002
tcp        0      0 0.0.0.0:9002            0.0.0.0:*               LISTEN      15998/nginx     
root@VM-169-246-ubuntu:/etc/nginx# netstat -anp|grep 9001
tcp        0      0 10.251.169.246:9001     0.0.0.0:*               LISTEN      5585/python     
</code></pre>

<p>一直以为是nginx配置错误，最后发现是9002被防火墙屏蔽了，输入命令 :</p>

<pre><code>root@VM-169-246-ubuntu:/etc/nginx# ufw allow 9002
Rule added
Rule added (v6)
</code></pre>

<p>此时在浏览器输入 ip:port，终于正常了。</p>

<p>参考文章：</p>

<p><a href="http://blog.csdn.net/ithomer/article/details/19117777">参考1</a><br />
<a href="http://www.2cto.com/os/201503/378878.html">参考2</a></p>
</div>

    

    <hr>
    <div class="text-justify">
    
        <div id="comments-gitment"></div>
            <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
            <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
            <script type="text/javascript">
            const gitment = new Gitment({
              id: '2015-09-18 09:10:00 \x2b0800 \x2b0800',
              title: 'ubuntu下supervisor安装与使用笔记',
              link: decodeURI(location.href),
              desc: '1、supervisor 介绍 它是个什么东东？用来干嘛的？\nsupervisor是linux下的进程管理工具，python编写。用来监控进程的运行。比如说你要一直运行进程A，使用supervisor后，如果A进程崩掉了， 或者意外被kill了，supervisor可以快速帮你重新启动A，当然还有其他功能。待我后面一一挖掘。\n2、supervisor 安装 安装环境：\n ubuntu 14.04\npython 2.7.6\n 这里我选择在线安装，可以参考官网的文档， 使用Setuptools在线安装。需要先安装Setuptools，这里，我尝试了两种方式安装：\n（1）、手动下载 ez_setup.py,下载地址,然后使用命令：\nroot@st-B85M-DS3H:~\/tools# python ez_setup.py  如果安装成功，会显示：\nInstalled \/usr\/local\/lib\/python2.7\/dist-packages\/setuptools-18.2-py2.7.egg Processing dependencies for setuptools==18.2 Finished processing dependencies for setuptools==18.2  （2）、ubuntu下，直接使用apt-get安装\nroot@st-B85M-DS3H:~\/Projects# sudo apt-get install python-setuptools  如果安装成功，最后会显示：\nUnpacking python-setuptools (3.3-1ubuntu2) ... Setting up python-pkg-resources (3.3-1ubuntu2) ... Setting up python-setuptools (3.3-1ubuntu2) ...  输入命令：\nroot@st-B85M-DS3H:~\/Projects# easy_install --help  检查是否安装成功。\n安装好setuptools之后，使用命令easy_install supervisor ,开始安装supervisor。\n当然，也可以下载源码，解压后，使用命令 python setup.',
              owner: 'shuimu98',
              repo: 'shuimu98.github.io',
              oauth: {
                client_id: 'af5065a1372570c7babc',
                client_secret: '3bd955012d21847887f0d3d4f9ea3c2cbc2b7e10'
              }
            })
            gitment.render('comments-gitment')
            </script>
    
    </div>

</main>

        <footer id = "bigfooter">
            <div style = "padding:15px;">
                <p>Powered by <a href="https://gohugo.io">Hugo</a>. Themed by <a href="https://github.com/nathancday/min_night">min_night</a>.
                </p>
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/"
                title="Creative Commons Attribution 4.0 International license">
                <i class="fa fa-creative-commons" aria-hidden="true"></i> Attribution 4.0 International license
                </a>
            </div>
        </footer>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());
          gtag('config', '');
        </script>
       
    </body>

</html>

